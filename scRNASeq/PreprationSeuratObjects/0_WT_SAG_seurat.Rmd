---
title: "P9 Wildtype Mouse SAG suture scRNA "
author: "Huan"
date: "11/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 120),
  message = TRUE,
  warning = FALSE,
  cache = TRUE
)
```

This note was used for single cell RNA-seq analysis of P9 Wildtype Mouse SAG suture. # summary for the goal of this current research 
Sample ID: `WT_SAG`  #Name for the folder containing 10x output Before start the following analysis, you need to create a folder with 10xoutput folder and a related Rproject.

# 1 Setup of analysis environment

## 1.1 Package installation

Seurat (v3), ggplot2 and sctransform packages were installed. Here we use sctransform for scRNAseq normalization, but you can also use the routine approach.

## 1.2 Load environment and packages

```{r load of packages and setup of the environment}
gc()
rm(list=ls())
library(Seurat)
library(ggplot2)
library(sctransform)
set.seed(12)
theme_set(theme_bw())

```

# 1.3 Load data and create Seurat object

```{r, load 10X datasets}
WT_SAG_data <- Read10X(data.dir = "./WT_SAG/") # you will change the prefix, ie., WT_SAG_ before data."WT_SAG" is the folder containing 10xOutput.


```

```{r, create Seurat object}
WT_SAG <- CreateSeuratObject(counts =WT_SAG_data, project = "WT_SAG", min.cells = 3, min.features = 200)
WT_SAG #Check the strucuture of seurat object #21433 features across 8496 samples within 1 assay  
saveRDS(WT_SAG, file="./SeuratObject/WT_SAG_raw.rds") #save the raw Seurat object with related prefix.
```

# 2 Initial analysis

## 2.1 Initial analysis was performed using SCTransform

First, QC for all cells counted by Cell Ranger

```{r, initial QC}

# store mitochondrial percentage in object meta data
WT_SAG <- PercentageFeatureSet(WT_SAG, pattern = "^mt-", col.name = "percent.mt") # If you are working with Human sample, change ^mt to ^MT.

# Show QC metrics for the first 5 cells

head(WT_SAG@meta.data, 5)

# Visualize QC metrics as a violin plot
VlnPlot(WT_SAG, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
# Scatter plot for correlation between count and Mt RNA
## Correlation between nCount_RNA and percent.mt
plot1 <- FeatureScatter(WT_SAG, feature1 = "nCount_RNA", feature2 = "percent.mt")
# Correlation between nCount_RNA and nFeature_RNA
plot2 <- FeatureScatter(WT_SAG, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2 #combine both

WT_SAG #21433 features across 8496 samples within 1 assay 
```

Second, filter "strange" cells depending on the nFeature_RNA and mt

```{r, filter cells and QC}
# Filter cells
WT_SAG <- subset(WT_SAG, subset = nFeature_RNA > 1000 & 
               nFeature_RNA < 7500  &
               percent.mt < 10)
# You may adjust the above parameters according to the plots above. Here we want to remove cells with nFeature_RNA>1000 and less than 7500, mt%<10

# Scatter plot for correlation between count and Mt RNA
## Correlation between nCount_RNA and percent.mt
plot1 <- FeatureScatter(WT_SAG, feature1 = "nCount_RNA", feature2 = "percent.mt")
# Correlation between nCount_RNA and nFeature_RNA
plot2 <- FeatureScatter(WT_SAG, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2 #combine both, correlation between nRNA and nFeature should be more than 0.9

VlnPlot(WT_SAG, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

WT_SAG #21433 features across 7478 samples within 1 assay 
```

Third, one-step-regression using SCTransform Refer to <https://satijalab.org/seurat/articles/sctransform_vignette.html> to check the vignette of SCTransform.

    Note that this single command replaces NormalizeData(), ScaleData(), and FindVariableFeatures().
    Transformed data will be available in the SCT assay, which is set as the default after running sctransform
    During normalization, we can also remove confounding sources of variation, for example, mitochondrial mapping percentage

```{r, SCTransform}
# run sctransform regress to the precentage of mitochondria
WT_SAG <- SCTransform(WT_SAG, vars.to.regress = "percent.mt", verbose = FALSE)
```

## 2.2 Clustering and dimension reduction

PCA assay

```{r, PCA}
WT_SAG <- RunPCA(WT_SAG, features = VariableFeatures(object = WT_SAG))

```

Using a vector-based prediction, we chose the best parameter dims=1:30

```{r, reclustering,fig.height=8, fig.width=9}
# Find a suitable dim for clustering
library(tidyverse)
c(2,seq(from=3,by=3,length=10) )
map(c(2,seq(from=3,by=3,length=10) ) , function(x) { WT_SAG %>%  RunUMAP(n.neighbors = 50,n.epochs=105,dims = 1:x) %>% DimPlot()}) %>% cowplot::plot_grid(plotlist = .) # dims= 1:30 works best denpending on the "distance"

```

Other two more statistical approach can be used

```{r, determin dimsion}
#JackStraw but not applicable to SCTransform-normalized data
#WT_SAG <- JackStraw(WT_SAG, num.replicate = 100)
#WT_SAG <- ScoreJackStraw(WT_SAG, dims = 1:30)
#JackStrawPlot(WT_SAG, dims = 1:15)
#ElboPlot
ElbowPlot(WT_SAG, ndims=50) # actually no 'obvious' elbow point revealed on the graph, so we go ahead with 1:30 dim
```

We then perform clustering using UMAP using dim=1:30

```{r cluster and dimension-reduction, fig.width=5, fig.height=7}
# These are now standard steps in the Seurat workflow for visualization and clustering

WT_SAG <- RunUMAP(WT_SAG, dims = 1:30, verbose = FALSE)

WT_SAG <- FindNeighbors(WT_SAG, dims = 1:30, verbose = FALSE)
WT_SAG <- FindClusters(WT_SAG, verbose = FALSE)
DimPlot(WT_SAG, label = TRUE)


```

```{r, test umap}
DimPlot(WT_SAG, label = TRUE, pt.size = 0.5)
ggsave("./OutputFigure/WT_SAG_umap.pdf", device = "pdf", width =25 , height =22, units = "cm")
```

```{r, save output}
saveRDS(WT_SAG,file = "./SeuratObject/WT_SAG_Seurat.rds")
```

# 3 Marker genes and subset object

## 3.0 Load saved data and perform basic plot

```{r, load data}
WT_SAG <- readRDS("./SeuratObject/WT_SAG_Seurat.rds")

```

```{r,umap plot test}
DimPlot(WT_SAG, label = TRUE, pt.size = 0.5)

```

## 3.1 Find marker genes for each cluster

```{r, generally find marker genes}
WT_SAG_markers <- FindAllMarkers(object = WT_SAG, only.pos = TRUE, 
                               min.pct = 0.25, thresh.use = 0.25) #identify positive marker genes 
top10 <- WT_SAG_markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)

write.csv(WT_SAG_markers, file = "WT_SAG_markers_20221117.csv", row.names = FALSE) #adjust name accordingly
write.csv(top10, file = "WT_SAG_markers_top10_20221117.csv", row.names = FALSE) #adjust name accordingly

DoHeatmap(WT_SAG, features = top10$gene)
ggsave("./OutputFigure/WT_SAG_markers_top10_20221117.pdf", device = "pdf",#adjust name accordingly
       width = 30, #adjust according to the display of output
       height = 55, #adjust according to the display of output
       units = "cm")

```

## 3.2 Feature plot for different genes of interest

```{r,featureplot for genes of interest,fig.width=5, fig.height=9}
FeaturePlot(WT_SAG, features = c("Runx2","Fgfr2",
                                "Fgfr3","Igfr1",
                                "Igf2","Gli1",
                                "Ecad","Mki67",
                                "Sp7", "Postn"), ncol=2, pt.size = 0.1)
ggsave("./OutputFigure/WT_SAG_featurePlot_interest_markers.pdf", device = "pdf", width = 20, height =30, units = "cm")
```
